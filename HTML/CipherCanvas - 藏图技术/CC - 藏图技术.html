<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CipherCanvas PRO | ä¸“ä¸šçº§è§†è§‰éšå†™åè®®</title>
    <!-- è®¾ç½®ç½‘é¡µæ ‡ç­¾å›¾æ ‡ (Favicon) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%234f46e5%22/><text y=%22.9em%22 x=%22.1em%22 font-size=%2270%22 fill=%22white%22>âœ¨</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f8fafc; --bg-grad: linear-gradient(135deg, #f8fafc 0%, #eef2ff 100%);
            --surface: #ffffff; --primary: #4f46e5; --secondary: #ec4899;
            --text: #1e293b; --text-dim: #64748b; --border: #e2e8f0;
            --header-bg: rgba(255, 255, 255, 0.8); --card-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05); --input-bg: #f1f5f9;
            --danger: #f43f5e; --warning: #f59e0b;
        }
        .dark-mode {
            --bg: #0f172a; --bg-grad: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            --surface: #1e293b; --primary: #6366f1; --secondary: #f43f5e;
            --text: #f8fafc; --text-dim: #94a3b8; --border: rgba(255, 255, 255, 0.1);
            --header-bg: rgba(15, 23, 42, 0.8); --card-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.3); --input-bg: #0d1117;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Noto Sans SC', 'Montserrat', sans-serif; background: var(--bg); background-image: var(--bg-grad); color: var(--text); line-height: 1.6; min-height: 100vh; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); overflow-x: hidden; }
        
        /* --- åŠ¨ç”»ç³»ç»Ÿ --- */
        @keyframes modalShow {
            0% { transform: scale(0.9) translateY(20px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        @keyframes panelIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- å¼¹çª—æ ·å¼ --- */
        #notice-overlay, #msg-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px); z-index: 9999; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; }
        .notice-card { background: var(--surface); width: 92%; max-width: 520px; border-radius: 30px; padding: 35px; border: 1px solid var(--border); box-shadow: 0 25px 60px -15px rgba(0,0,0,0.3); text-align: center; transform: scale(0.9); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .modal-active { opacity: 1 !important; pointer-events: auto !important; }
        .modal-active .notice-card { transform: scale(1) !important; }

        .notice-icon { width: 60px; height: 60px; background: var(--input-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 26px; }
        .notice-card h3 { font-size: 1.45em; margin-bottom: 15px; color: var(--text); font-weight: 800; }
        .notice-content { text-align: left; background: var(--input-bg); padding: 22px; border-radius: 20px; margin-bottom: 25px; border: 1px solid var(--border); }
        .notice-item { display: flex; gap: 12px; margin-bottom: 12px; font-size: 0.9em; color: var(--text-dim); line-height: 1.5; }
        .notice-item b { color: var(--text); }
        .warning-zone { margin-top: 10px; padding-top: 15px; border-top: 1px dashed var(--border); color: #ef4444; font-size: 0.85em; display: flex; gap: 10px; font-weight: 600; }
        .btn-confirm { background: var(--primary); color: white; border: none; padding: 14px 40px; border-radius: 15px; font-weight: 700; cursor: pointer; transition: 0.3s; width: 100%; box-shadow: 0 5px 15px rgba(79, 70, 229, 0.3); }
        .btn-confirm:hover { filter: brightness(1.1); transform: translateY(-2px); }

        /* --- å¯¼èˆª --- */
        header { background: var(--header-bg); backdrop-filter: blur(12px); padding: 12px 40px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 1000; }
        .logo-area { display: flex; align-items: center; gap: 14px; cursor: pointer; text-decoration: none; }
        .logo-box { width: 38px; height: 38px; background: linear-gradient(45deg, var(--primary), var(--secondary)); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4); transform: rotate(-5deg); transition: 0.3s; }
        .logo-box::after { content: 'âœ¨'; font-size: 20px; }
        .logo-title { display: flex; flex-direction: column; }
        .logo-title .cn { font-size: 1.1em; font-weight: 800; color: var(--text); line-height: 1.2; letter-spacing: 1px; }
        .logo-title .en { font-size: 0.65em; font-weight: 600; color: var(--primary); text-transform: uppercase; letter-spacing: 2px; margin-top: 2px; }

        .nav-links { display: flex; gap: 10px; align-items: center; }
        .nav-btn { background: transparent; border: none; color: var(--text-dim); padding: 8px 20px; font-size: 0.9em; cursor: pointer; border-radius: 8px; transition: 0.3s; font-weight: 500; }
        .nav-btn:hover { color: var(--primary); background: var(--input-bg); }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        .theme-toggle { width: 44px; height: 44px; border-radius: 12px; border: 1px solid var(--border); background: var(--surface); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; margin-left: 10px; }

        /* --- ä¸»é¢æ¿ --- */
        main { padding: 40px 20px; max-width: 1100px; margin: 0 auto; width: 100%; }
        .panel { background: var(--surface); border: 1px solid var(--border); border-radius: 28px; padding: 40px; display: none; flex-direction: column; align-items: center; box-shadow: var(--card-shadow); transition: 0.3s; }
        .panel.active { display: flex; animation: panelIn 0.5s ease; }
        
        .home-hero { text-align: center; max-width: 800px; }
        .home-hero h2 { font-size: 2.2em; font-weight: 800; margin-bottom: 15px; background: linear-gradient(to right, var(--text), var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .divider { width: 60px; height: 4px; background: var(--primary); margin: 20px auto; border-radius: 2px; }
        .tech-specs { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; width: 100%; margin: 30px 0; border-top: 1px solid var(--border); padding-top: 30px; }
        .spec-item p { font-size: 1.1em; font-weight: 700; }

        .upload-row { display: flex; gap: 24px; flex-wrap: wrap; justify-content: center; width: 100%; }
        .upload-card { width: 300px; height: 200px; background: var(--input-bg); border: 2px dashed var(--border); border-radius: 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; transition: 0.3s; overflow: hidden; }
        .upload-card:hover { border-color: var(--primary); transform: translateY(-5px); }
        .upload-card input { display: none; }
        .upload-card img { width: 100%; height: 100%; object-fit: contain; position: absolute; z-index: 10; border-radius: 22px; display: none; background: var(--input-bg); }
        
        .btn-call { background: var(--primary); color: white; border: none; padding: 14px 45px; border-radius: 16px; font-weight: 700; cursor: pointer; transition: 0.3s; margin-top: 30px; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4); }
        .result-container { width: 100%; display: none; flex-direction: column; align-items: center; margin-top: 40px; }
        .view-frame { position: relative; background: #000; border-radius: 12px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        #decode-canvas { display: block; max-width: 100%; cursor: crosshair; touch-action: none; }

        .control-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 24px; width: 100%; margin-top: 30px; background: var(--input-bg); padding: 30px; border-radius: 20px; border: 1px solid var(--border); }
        .slider-group label { font-size: 0.8em; font-weight: 700; color: var(--text-dim); text-transform: uppercase; }
        .slider-group input { appearance: none; height: 6px; background: var(--border); border-radius: 3px; width: 100%; margin-top: 10px; }
        .slider-group input::-webkit-slider-thumb { appearance: none; width: 18px; height: 18px; background: var(--primary); border: 3px solid #fff; border-radius: 50%; cursor: pointer; }

        .float-btn { position: fixed; bottom: 30px; right: 30px; z-index: 1000; display: flex; align-items: center; flex-direction: row-reverse; gap: 12px; pointer-events: auto; cursor: default; }
        .ball { width: 58px; height: 58px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4); transition: 0.4s; }
        .ball svg { width: 24px; height: 24px; fill: white; }
        .ball-text { background: var(--surface); color: var(--text); padding: 8px 16px; border-radius: 12px; font-size: 13px; font-weight: 700; box-shadow: var(--card-shadow); opacity: 0; transform: translateX(10px); transition: 0.3s; white-space: nowrap; }
        .float-btn:hover .ball-text { opacity: 1; transform: translateX(0); }
        .float-btn:hover .ball { transform: rotate(15deg) scale(1.1); }

        footer { padding: 40px; text-align: center; }
        .footer-badge { display: inline-flex; align-items: center; gap: 12px; padding: 8px 24px; border-radius: 50px; background: var(--surface); border: 1px solid var(--border); font-size: 0.85em; color: var(--text-dim); }
        .footer-badge b { color: var(--primary); }
    </style>
</head>
<body onload="initApp()">

<!-- æ¶ˆæ¯æç¤ºå¼¹çª— (é«˜ä¿çœŸåŠ¨ç”») -->
<div id="msg-overlay" style="display: none;">
    <div class="notice-card" style="max-width: 420px;">
        <div class="notice-icon" id="msg-icon">âš ï¸</div>
        <h3 id="msg-title">ç³»ç»Ÿæç¤º</h3>
        <div class="notice-content" id="msg-text" style="text-align: center; font-size: 0.95em; color: var(--text);"></div>
        <button class="btn-confirm" onclick="closeMsg()">å¥½çš„ï¼Œæ˜ç™½äº†</button>
    </div>
</div>

<!-- å¼¹çª—å…¬å‘Š -->
<div id="notice-overlay" style="display: flex;">
    <div class="notice-card">
        <div class="notice-icon">ğŸ“‹</div>
        <h3>å…¬  å‘Š  æ </h3>
        <div class="notice-content">
            <div class="notice-item" style="display:block; text-align:center; margin-bottom:20px; color:var(--primary); font-weight:700; font-size: 1em;">
                âœ¨ å…ˆè¿›çš„ DDM å·®åˆ†æŠ€æœ¯æ‰€å®ç°çš„çœŸæ­£çš„å›¾è—å›¾åŠŸèƒ½ï¼šæœ¬ç³»ç»ŸåŸºäºå…‰å­çº§åƒç´ å¯¹å†²åè®®ï¼Œè®©æ¯ä¸€å¼ æ™®é€šå›¾ç‰‡éƒ½èƒ½æˆä¸ºæ‰¿è½½å½©è‰²ç§˜å¯†çš„å®‰å…¨è½½ä½“ã€‚
            </div>
            <div class="notice-item"><span>ğŸ”¹</span><p>æœ¬å¹³å°ä»…æ”¯æŒ <b>å›¾åƒåª’ä½“</b> (.png, .jpg, .webp) è¿›è¡Œç©ºé—´åµŒå…¥æ“ä½œã€‚</p></div>
            <div class="notice-item"><span>ğŸš«</span><p>ä¸¥ç¦å¯¼å…¥ <b>è§†é¢‘ã€éŸ³é¢‘ã€å‹ç¼©åŒ…</b> ç­‰éå½±åƒæ ¼å¼ï¼Œç³»ç»Ÿå°†æ— æ³•é€šè¿‡äºŒè¿›åˆ¶æ ¡éªŒã€‚</p></div>
            <div class="notice-item"><span>ğŸ“</span><p>æ‰§è¡Œéšè—æ“ä½œæ—¶ï¼Œç§˜å¯†å›¾ç‰‡ä¸è½½ä½“å›¾çš„ <b>ç‰©ç†åˆ†è¾¨ç‡å¿…é¡»å®Œå…¨ç›¸åŒ</b>ã€‚</p></div>
            <div class="warning-zone">
                <span>âš ï¸</span>
                <p><b>è­¦ç¤ºï¼š</b>è‹¥è§£ç å½±åƒä¸åŸå›¾ä¸ç¬¦ï¼Œæˆ–ç‚¹å‡»ä¿å­˜æŒ‰é’®å‡ºç°æ–‡ä»¶æœªçŸ¥/æŸåï¼Œå¤šä¸ºå†…æ ¸å…¼å®¹æ€§åŸå› ã€‚å¼ºçƒˆæ¨èåˆ‡æ¢è‡³ <b>Chrome</b> æˆ– <b>Edge</b> æµè§ˆå™¨è¿›è¡Œå°è¯•ã€‚</p>
            </div>
        </div>
        <button class="btn-confirm" onclick="closeNotice()">æˆ‘å·²é˜…è¯»å¹¶çŸ¥æ™“</button>
    </div>
</div>

<header>
    <a href="#" class="logo-area" onclick="switchPanel('home')">
        <div class="logo-box"></div>
        <div class="logo-title">
            <span class="cn">æ™ºèƒ½éšå›¾æŠ€æœ¯</span>
            <span class="en">CipherCanvas Protocol</span>
        </div>
    </a>
    <nav class="nav-links">
        <button class="nav-btn active" id="nav-home" onclick="switchPanel('home')">é¦–é¡µ</button>
        <button class="nav-btn" id="nav-encode" onclick="switchPanel('encode')">éšè—ç¼–ç </button>
        <button class="nav-btn" id="nav-decode" onclick="switchPanel('decode')">è¿˜åŸè§£ç </button>
        <button class="theme-toggle" onclick="toggleTheme()"><svg id="theme-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"></svg></button>
    </nav>
</header>

<main>
    <section id="panel-home" class="panel active">
        <div class="home-hero">
            <h2>æ— ç—•è§†è§‰åµŒå…¥ä¸å…‰è°±é‡å»ºåè®®</h2>
            <div class="divider"></div>
            <p>åŸºäº Neutral-DDM å·®åˆ†è°ƒåˆ¶æŠ€æœ¯ï¼Œå®ç°åœ¨å¤æ‚å½±åƒä»‹è´¨ä¸­å»ºç«‹éšå½¢æ•°æ®é€šé“ã€‚</p>
        </div>
        <div style="max-width: 650px; text-align: center; color: var(--text-dim); margin-bottom: 20px; font-size: 0.95em;">
            ç³»ç»Ÿé€šè¿‡å¯¹åº•å±‚åƒç´ ç°‡çš„å¾®è§‚å¯¹å†²è®¡ç®—ï¼Œåœ¨ä¿éšœè½½ä½“å½±åƒç‰¹å¾ç»å¯¹å®ˆæ’çš„å‰æä¸‹å®ç° 24-bit å½©è‰²éšè—ã€‚æ”¯æŒå¤šç«¯æ— æŸè¿˜åŸï¼Œå¹¶æä¾›åæœŸç²¾ç»†åŒ–çš„å½±åƒæ ¡å‡†æ–¹æ¡ˆã€‚
        </div>
        <div class="tech-specs">
            <div class="spec-item"><h4>åŠ å¯†ç²¾åº¦</h4><p>Vector-Level</p></div>
            <div class="spec-item"><h4>è‰²æ·±æ”¯æŒ</h4><p>24-bit TrueColor</p></div>
            <div class="spec-item"><h4>æ ¸å¿ƒåè®®</h4><p>Neutral-DDM v4</p></div>
        </div>
        <button class="btn-call" onclick="switchPanel('encode')">å¼€å§‹ä½¿ç”¨</button>
    </section>

    <section id="panel-encode" class="panel">
        <div style="text-align: center; margin-bottom: 40px;"><h2>åˆ¶ä½œåŠ å¯†è—å›¾</h2><p>è¯·ä¸Šä¼ <b>åˆ†è¾¨ç‡å®Œå…¨ä¸€è‡´</b>çš„ç§˜å¯†æºå†…å®¹ä¸è½½ä½“èƒŒæ™¯</p></div>
        <div class="upload-row">
            <label class="upload-card"><input type="file" onchange="pImg(this,'s-p')"><div class="u-icon">ğŸ¨</div><div class="u-label">ç§˜å¯†å›¾ç‰‡æº</div><img id="s-p"></label>
            <label class="upload-card"><input type="file" onchange="pImg(this,'c-p')"><div class="u-icon">ğŸ–¼ï¸</div><div class="u-label">ç‰©ç†è½½ä½“å›¾</div><img id="c-p"></label>
        </div>
        <button class="btn-call" onclick="startEnc()">âš¡ å¼€å§‹ç”Ÿæˆ</button>
        <div id="enc-res" class="result-container">
            <p style="color:#10b981; font-weight:700; margin-bottom:20px;">âœ“ åµŒå…¥æˆåŠŸï¼šä¿¡æ¯å·²ç‰©ç†å‰¥ç¦»å½±å­ç‰¹å¾</p>
            <img id="res-img" style="max-width: 100%; border-radius: 12px; border: 1px solid var(--border);">
            <a id="dl-enc" class="btn-call" style="text-decoration:none; background: #10b981;" download="secret_cipher.png">ğŸ“¥ ä¸‹è½½é«˜ä¿çœŸè—å›¾ (PNG)</a>
        </div>
    </section>

    <section id="panel-decode" class="panel">
        <div style="text-align: center; margin-bottom: 40px;"><h2>å½±åƒå…‰è°±è¿˜åŸ</h2><p>å¯¼å…¥å«æœ‰åŠ å¯†ä¿¡æ¯çš„å›¾åƒï¼Œæ‰§è¡Œç®—æ³•è§£æä¸åæœŸæ ¡å‡†</p></div>
        <div class="upload-row"><label class="upload-card"><input type="file" onchange="pImg(this,'d-p')"><div class="u-icon">ğŸ”</div><div class="u-label">å¯¼å…¥å¾…è§£å¯†å›¾åƒ</div><img id="d-p"></label></div>
        <button class="btn-call" onclick="startDec()">ğŸ”“ å¯åŠ¨é‡å»ºåºåˆ—</button>
        <div id="dec-res" class="result-container">
            <div class="view-frame"><canvas id="decode-canvas"></canvas></div>
            <div class="control-grid">
                <div class="slider-group"><label>æ›å…‰è¡¥å¿</label><input type="range" id="f-exp" min="-60" max="60" value="0" oninput="fx()"></div>
                <div class="slider-group"><label>å¯¹æ¯”å¼ºåº¦</label><input type="range" id="f-con" min="0.8" max="2.2" step="0.05" value="1.85" oninput="fx()"></div>
                <div class="slider-group"><label>è‰²å½©æµ“åº¦</label><input type="range" id="f-sat" min="0" max="200" value="110" oninput="fx()"></div>
                <div class="slider-group"><label>å¤å¤è‰²æ¸©</label><input type="range" id="f-sep" min="0" max="100" value="0" oninput="fx()"></div>
                <div class="slider-group"><label>è‰²ç›¸æ—‹è½¬</label><input type="range" id="f-hue" min="0" max="360" value="0" oninput="fx()"></div>
                <div class="slider-group"><label>é«˜æ–¯æ¨¡ç³Š</label><input type="range" id="f-blr" min="0" max="10" step="0.1" value="0" oninput="fx()"></div>
                <p style="grid-column: 1/-1; font-size: 0.8em; color: var(--primary); text-align: center; margin-top:10px;">äº¤äº’æŒ‡å¼•ï¼šåœ¨å›¾ç‰‡è¾¹ç¼˜æ‹–æ‹½å¯è°ƒæ•´è£å‰ªèŒƒå›´ (é»˜è®¤ä¸ºå…¨å›¾)</p>
                <button class="btn-call" style="background: linear-gradient(to right, #10b981, #059669); grid-column: 1/-1; margin-top:15px; width:100%;" onclick="save()">ğŸ’¾ å¯¼å‡ºæœ€ç»ˆè¿˜åŸå½±åƒ</button>
            </div>
        </div>
    </section>
</main>

<div class="float-btn">
    <div class="ball"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg></div>
    <div class="ball-text">è”ç³»æˆ‘ï¼QQï¼š965629725</div>
</div>

<footer><div class="footer-badge">Neutral-DDM è½½ä½“ä¸­å’Œå·®åˆ†ç¼–ç  <b>|</b> <b>å°ç­–</b> DESIGN</div></footer>

<script>
    let rawCvs = null, crop = { x: 0, y: 0, w: 200, h: 200 }, dMode = null;
    const BLK = 2, S_VAL = 14, $ = id => document.getElementById(id);

    // --- å¼¹çª—é€»è¾‘å‡çº§ ---
    function initApp() {
        setTimeout(() => $('notice-overlay').classList.add('modal-active'), 100);
    }

    function showMsg(title, text, icon = 'âš ï¸') {
        $('msg-title').innerText = title;
        $('msg-text').innerText = text;
        $('msg-icon').innerText = icon;
        const msg = $('msg-overlay');
        msg.style.display = 'flex';
        setTimeout(() => msg.classList.add('modal-active'), 10);
    }

    function closeMsg() {
        const msg = $('msg-overlay');
        msg.classList.remove('modal-active');
        setTimeout(() => msg.style.display = 'none', 350);
    }

    function closeNotice() {
        const overlay = $('notice-overlay');
        overlay.classList.remove('modal-active');
        setTimeout(() => {
            overlay.style.display = 'none';
            document.body.style.overflow = 'auto';
        }, 400);
    }

    // --- åˆ†è¾¨ç‡ä¸æ–‡ä»¶æ ¡éªŒé€»è¾‘ ---
    function pImg(i, id) {
        const file = i.files[0];
        if (!file) return;
        if (!file.type.startsWith('image/')) {
            showMsg('æ ¼å¼æ‹¦æˆª', 'æ­¤ç³»ç»Ÿä»…æ”¯æŒå¤„ç†å›¾ç‰‡æ ¼å¼ã€‚è¯·ç§»é™¤è§†é¢‘æˆ–å…¶ä»–éå›¾åƒæ–‡ä»¶ã€‚', 'âŒ');
            i.value = ''; return;
        }
        const r = new FileReader(); 
        r.onload = e => { $(id).src = e.target.result; $(id).style.display = 'block'; }; 
        r.readAsDataURL(file);
    }

    async function startEnc() {
        if(!$('s-p').src || !$('c-p').src) return showMsg('èµ„æºæœªé€‰', 'è¯·åˆ†åˆ«è½½å…¥â€œç§˜å¯†æºå›¾â€ä¸â€œè½½ä½“å›¾â€åå†å¯åŠ¨åµŒå…¥ç¨‹åºã€‚');
        const si = await loadA($('s-p').src), ci = await loadA($('c-p').src);
        
        // åˆ†è¾¨ç‡å¼ºåˆ¶ç›¸åŒæ ¡éªŒ
        if (si.width !== ci.width || si.height !== ci.height) {
            showMsg('åˆ†è¾¨ç‡ä¸åŒ¹é…', `é”™è¯¯ï¼šç§˜å¯†å›¾ç‰‡åˆ†è¾¨ç‡(${si.width}x${si.height})ä¸è½½ä½“å›¾ç‰‡åˆ†è¾¨ç‡(${ci.width}x${ci.height})ä¸ä¸€è‡´ã€‚æœ¬ç®—æ³•è¦æ±‚ä¸¤å›¾å°ºå¯¸å¿…é¡»å®Œå…¨ç›¸åŒã€‚`, 'ğŸ“');
            return;
        }

        const cvs = document.createElement('canvas'), ctx = cvs.getContext('2d');
        cvs.width = ci.width; cvs.height = ci.height; ctx.drawImage(ci, 0, 0);
        const idat = ctx.getImageData(0,0,cvs.width,cvs.height), p = idat.data;
        const sw = Math.floor(cvs.width/BLK), sh = Math.floor(cvs.height/BLK);
        const scvs = document.createElement('canvas'); scvs.width = sw; scvs.height = sh;
        scvs.getContext('2d').drawImage(si, 0, 0, sw, sh);
        const sp = scvs.getContext('2d').getImageData(0,0,sw,sh).data;

        for(let y=0; y<sh; y++) {
            for(let x=0; x<sw; x++) {
                const sIdx = (y*sw+x)*4, cx=x*BLK, cy=y*BLK;
                const i00=(cy*cvs.width+cx)*4, i01=(cy*cvs.width+cx+1)*4, i10=((cy+1)*cvs.width+cx)*4, i11=((cy+1)*cvs.width+cx+1)*4;
                for(let k=0; k<3; k++) {
                    let avg = (p[i00+k]+p[i01+k]+p[i10+k]+p[i11+k])/4;
                    if(avg<16) avg=16; if(avg>239) avg=239;
                    const sig = Math.round((sp[sIdx+k]-128)/128*S_VAL);
                    p[i00+k]=p[i11+k]=avg+sig; p[i01+k]=p[i10+k]=avg-sig;
                }
            }
        }
        ctx.putImageData(idat,0,0);
        $('res-img').src = $('dl-enc').href = cvs.toDataURL('image/png');
        $('enc-res').style.display = 'flex';
    }

    // --- å…¶ä»–é€»è¾‘ä¿æŒä¸å˜ ---
    function switchPanel(id) {
        const panels = document.querySelectorAll('.panel');
        panels.forEach(p => p.classList.remove('active'));
        setTimeout(() => {
            panels.forEach(p => p.style.display = p.id === 'panel-'+id ? 'flex' : 'none');
            $('panel-'+id).classList.add('active');
        }, 100);
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.id === 'nav-'+id));
    }

    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const isD = document.body.classList.contains('dark-mode');
        $('theme-icon').innerHTML = isD ? '<path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M6.343 6.343l-.707-.707M12 8a4 4 0 100 8 4 4 0 000-8z"/>' : '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>';
    }
    toggleTheme(); toggleTheme();

    const loadA = src => new Promise(r => { const i = new Image(); i.onload = () => r(i); i.src = src; });

    async function startDec() {
        if(!$('d-p').src) return showMsg('è§£æå¤±è´¥', 'è¯·å¯¼å…¥å«æœ‰ç§˜å¯†ä¿¡æ¯çš„åŠ å¯†è—å›¾æ–‡ä»¶ã€‚');
        const di = await loadA($('d-p').src);
        const cvs = document.createElement('canvas'), ctx = cvs.getContext('2d');
        cvs.width = di.width; cvs.height = di.height; ctx.drawImage(di,0,0);
        const p = ctx.getImageData(0,0,cvs.width,cvs.height).data;
        const sw = Math.floor(cvs.width/BLK), sh = Math.floor(cvs.height/BLK);
        rawCvs = document.createElement('canvas'); rawCvs.width = sw; rawCvs.height = sh;
        const octx = rawCvs.getContext('2d'), odat = octx.createImageData(sw,sh), op = odat.data;

        for(let y=0; y<sh; y++) {
            for(let x=0; x<sw; x++) {
                const cx=x*BLK, cy=y*BLK, i00=(cy*cvs.width+cx)*4, i01=(cy*cvs.width+cx+1)*4, i10=((cy+1)*cvs.width+cx+1)*4, i11=((cy+1)*cvs.width+cx+1)*4, oi=(y*sw+x)*4;
                for(let k=0; k<3; k++) op[oi+k] = Math.max(0, Math.min(255, Math.round(((p[i00+k]+p[i11+k]-p[i01+k]-p[i10+k])/(S_VAL*4))*128+128)));
                op[oi+3]=255;
            }
        }
        octx.putImageData(odat,0,0);
        crop = { x: 0, y: 0, w: sw, h: sh };
        $('dec-res').style.display = 'flex';
        fx(); initCrop();
    }

    function fx() {
        if(!rawCvs) return;
        const dcvs = $('decode-canvas'), ctx = dcvs.getContext('2d');
        dcvs.width = rawCvs.width; dcvs.height = rawCvs.height;
        ctx.filter = `brightness(${100+parseInt($('f-exp').value)}%) contrast(${$('f-con').value}) saturate(${$('f-sat').value}%) sepia(${$('f-sep').value}%) hue-rotate(${$('f-hue').value}deg) blur(${$('f-blr').value}px)`;
        ctx.drawImage(rawCvs, 0, 0);
        ctx.strokeStyle = '#4f46e5'; ctx.lineWidth = 2; ctx.setLineDash([8, 4]); ctx.strokeRect(crop.x, crop.y, crop.w, crop.h);
        ctx.fillStyle = 'rgba(0,0,0,0.6)'; ctx.beginPath(); ctx.rect(0, 0, dcvs.width, dcvs.height); ctx.rect(crop.x, crop.y, crop.w, crop.h); ctx.fill("evenodd");
    }

    // é€‚é…ç§»åŠ¨ç«¯ä¸æ¡Œé¢çš„è£å‰ªäº¤äº’é€»è¾‘
    function initCrop() {
        const cvs = $('decode-canvas');
        
        const handleStart = (clientX, clientY) => {
            const r = cvs.getBoundingClientRect();
            const mx = (clientX - r.left) * (cvs.width / r.width), my = (clientY - r.top) * (cvs.height / r.height), t = 20;
            if (mx > crop.x + t && mx < crop.x + crop.w - t && my > crop.y + t && my < crop.y + crop.h - t) dMode = 'move';
            else if (Math.abs(mx - crop.x) < t) dMode = 'left'; else if (Math.abs(mx - (crop.x + crop.w)) < t) dMode = 'right';
            else if (Math.abs(my - crop.y) < t) dMode = 'top'; else if (Math.abs(my - (crop.y + crop.h)) < t) dMode = 'bottom';
        };

        const handleMove = (clientX, clientY) => {
            if (!dMode) return;
            const r = cvs.getBoundingClientRect();
            const mx = (clientX - r.left) * (cvs.width / r.width), my = (clientY - r.top) * (cvs.height / r.height);
            if(dMode === 'move') { 
                crop.x = Math.max(0, Math.min(cvs.width - crop.w, mx - crop.w / 2)); 
                crop.y = Math.max(0, Math.min(cvs.height - crop.h, my - crop.h / 2)); 
            } else {
                if(dMode === 'left'){ let ox = crop.x; crop.x = Math.max(0, Math.min(ox + crop.w - 40, mx)); crop.w += (ox - crop.x); }
                if(dMode === 'right') crop.w = Math.max(40, Math.min(cvs.width - crop.x, mx - crop.x));
                if(dMode === 'top'){ let oy = crop.y; crop.y = Math.max(0, Math.min(oy + crop.h - 40, my)); crop.h += (oy - crop.y); }
                if(dMode === 'bottom') crop.h = Math.max(40, Math.min(cvs.height - crop.y, my - crop.y));
            }
            fx();
        };

        cvs.onmousedown = e => handleStart(e.clientX, e.clientY);
        window.onmousemove = e => handleMove(e.clientX, e.clientY);
        window.onmouseup = () => dMode = null;

        // ç§»åŠ¨ç«¯ Touch ä¿®å¤
        cvs.addEventListener('touchstart', e => { 
            if (e.touches.length > 0) handleStart(e.touches[0].clientX, e.touches[0].clientY);
            e.preventDefault(); 
        }, { passive: false });
        cvs.addEventListener('touchmove', e => { 
            if (e.touches.length > 0) handleMove(e.touches[0].clientX, e.touches[0].clientY);
            e.preventDefault(); 
        }, { passive: false });
        cvs.addEventListener('touchend', () => dMode = null);
    }

    function save() {
        const fcvs = document.createElement('canvas'), fctx = fcvs.getContext('2d');
        fcvs.width = crop.w; fcvs.height = crop.h;
        fctx.filter = `brightness(${100+parseInt($('f-exp').value)}%) contrast(${$('f-con').value}) saturate(${$('f-sat').value}%) sepia(${$('f-sep').value}%) hue-rotate(${$('f-hue').value}deg) blur(${$('f-blr').value}px)`;
        fctx.drawImage(rawCvs, crop.x, crop.y, crop.w, crop.h, 0, 0, crop.w, crop.h);
        const l = document.createElement('a'); l.download = 'recovered_final.png'; l.href = fcvs.toDataURL(); l.click();
    }
</script>
</body>
</html>